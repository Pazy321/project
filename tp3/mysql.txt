-- База данных: glampling
CREATE DATABASE IF NOT EXISTS glampling CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE glampling;

-- Таблица для хранения ключей шифрования
CREATE TABLE encryption_keys (
    id INT AUTO_INCREMENT PRIMARY KEY,
    key_name VARCHAR(100) NOT NULL UNIQUE,
    key_value TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE
);

-- Таблица бронирований с зашифрованными данными
CREATE TABLE bookings (
    id INT AUTO_INCREMENT PRIMARY KEY,
    checkin_date DATE NOT NULL,
    checkout_date DATE NOT NULL,
    adults INT NOT NULL,
    children INT DEFAULT 0,
    infants INT DEFAULT 0,
    total_price DECIMAL(10,2) NOT NULL,
    
    -- Зашифрованные поля
    guest_name_encrypted TEXT NOT NULL,
    guest_phone_encrypted TEXT NOT NULL,
    guest_email_encrypted TEXT,
    
    -- Хеш для поиска (необратимый)
    guest_phone_hash VARCHAR(64),
    
    status ENUM('pending', 'confirmed', 'cancelled') DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_phone_hash (guest_phone_hash),
    INDEX idx_status (status),
    INDEX idx_dates (checkin_date, checkout_date)
);

-- Таблица доступных дат
CREATE TABLE availability (
    id INT AUTO_INCREMENT PRIMARY KEY,
    date DATE NOT NULL UNIQUE,
    is_available BOOLEAN DEFAULT TRUE,
    price DECIMAL(10,2) DEFAULT 6000.00,
    booking_id INT NULL,
    FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE SET NULL,
    INDEX idx_date (date),
    INDEX idx_available (is_available)
);

-- Таблица отзывов
CREATE TABLE reviews (
    id INT AUTO_INCREMENT PRIMARY KEY,
    guest_name VARCHAR(100) NOT NULL,
    avatar_url VARCHAR(255),
    review_text TEXT NOT NULL,
    rating INT CHECK (rating >= 1 AND rating <= 5),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_approved BOOLEAN DEFAULT FALSE,
    INDEX idx_approved (is_approved),
    INDEX idx_created (created_at)
);

-- Таблица заявок
CREATE TABLE applications (
    id INT AUTO_INCREMENT PRIMARY KEY,
    type VARCHAR(50) NOT NULL,
    contact_info_encrypted TEXT,
    message_encrypted TEXT,
    source VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('new', 'processed') DEFAULT 'new'
);


INSERT INTO encryption_keys (key_name, key_value) 
VALUES ('personal_data_key', 'd6f8c92a4e7b01f3a5e8c2d9b4f6a1c7e3d8a0f9b2c5e7a1d4f8c92a4e7b01f3');